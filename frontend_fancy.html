<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ TaskFlow - Modern Todo Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f1f5f9;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }

        .card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.8s ease-out;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--secondary);
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-header .icon {
            width: 2rem;
            height: 2rem;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .task-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: var(--transition);
            animation: slideInLeft 0.5s ease-out;
        }

        .task-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .task-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .task-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
        }

        .task-description {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .task-children {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        .notification.success {
            background: var(--accent);
        }

        .notification.error {
            background: var(--danger);
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Dark mode styles */
        [data-theme="dark"] {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #374151;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #4b5563;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        [data-theme="dark"] .form-input {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .task-item {
            background: var(--bg-secondary);
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-tasks"></i> TaskFlow</h1>
            <p>Organize your tasks with style and efficiency</p>
            <button class="btn btn-secondary" onclick="toggleTheme()" style="margin-top: 1rem; padding: 0.5rem 1rem;">
                <i class="fas fa-moon" id="theme-icon"></i>
                <span id="theme-text">Dark Mode</span>
            </button>
        </header>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <div class="icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <h2>Your Tasks</h2>
                </div>

                <div class="stats" id="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-tasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="root-tasks">0</div>
                        <div class="stat-label">Root Tasks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="child-tasks">0</div>
                        <div class="stat-label">Sub Tasks</div>
                    </div>
                </div>

                <div id="task-list" class="task-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading tasks...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h2>Add New Task</h2>
                </div>

                <form id="task-form">
                    <div class="form-group">
                        <label class="form-label" for="name">
                            <i class="fas fa-tag"></i> Task Name
                        </label>
                        <input type="text" id="name" class="form-input" placeholder="Enter task name..." required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">
                            <i class="fas fa-align-left"></i> Description
                        </label>
                        <textarea id="description" class="form-input form-textarea" placeholder="Describe your task..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="parent_id">
                            <i class="fas fa-sitemap"></i> Parent Task ID (Optional)
                        </label>
                        <input type="text" id="parent_id" class="form-input" placeholder="Enter parent task ID...">
                        <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.25rem; display: block;">
                            Leave empty to create a root task
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        let tasks = [];

        // DOM Elements
        const taskList = document.getElementById('task-list');
        const taskForm = document.getElementById('task-form');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const parentIdInput = document.getElementById('parent_id');

        // Statistics elements
        const totalTasksEl = document.getElementById('total-tasks');
        const rootTasksEl = document.getElementById('root-tasks');
        const childTasksEl = document.getElementById('child-tasks');

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateStats() {
            const totalTasks = tasks.length;

            // Calculate root tasks (tasks that are not children of any other task)
            const rootTasks = tasks.filter(task => {
                return !tasks.some(t => t.children && t.children.includes(task.id));
            }).length;

            const childTasks = totalTasks - rootTasks;

            totalTasksEl.textContent = totalTasks;
            rootTasksEl.textContent = rootTasks;
            childTasksEl.textContent = childTasks;
        }

        function truncateId(id) {
            return id.substring(0, 8) + '...';
        }

        function buildTaskHierarchy() {
            const taskMap = new Map();
            const rootTasks = [];

            // Create a map of all tasks
            tasks.forEach(task => {
                taskMap.set(task.id, { ...task, children: [] });
            });

            // Build hierarchy
            tasks.forEach(task => {
                const taskObj = taskMap.get(task.id);
                if (task.children && task.children.length > 0) {
                    task.children.forEach(childId => {
                        const childTask = taskMap.get(childId);
                        if (childTask) {
                            taskObj.children.push(childTask);
                        }
                    });
                }

                // Check if this task is a root task (not a child of any other task)
                const isChild = tasks.some(t => t.children && t.children.includes(task.id));
                if (!isChild) {
                    rootTasks.push(taskObj);
                }
            });

            return rootTasks;
        }

        function renderTaskItem(task, level = 0) {
            const indent = level * 20;
            const hasChildren = task.children && task.children.length > 0;

            return `
                <div class="task-item" style="margin-left: ${indent}px; ${level > 0 ? 'border-left: 3px solid var(--primary); margin-top: 0.5rem;' : ''}">
                    <div class="task-header">
                        <div class="task-title">
                            ${level > 0 ? '<i class="fas fa-arrow-turn-down" style="margin-right: 0.5rem; color: var(--primary);"></i>' : ''}
                            ${task.name}
                        </div>
                        <div class="task-id" onclick="copyToClipboard('${task.id}')" style="cursor: pointer;" title="Click to copy full ID">
                            #${truncateId(task.id)}
                        </div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    <div class="task-meta">
                        <div class="task-children">
                            <i class="fas fa-sitemap"></i>
                            <span>${task.children ? task.children.length : 0} subtasks</span>
                        </div>
                        ${task.due_date ? `
                            <div>
                                <i class="fas fa-calendar"></i>
                                <span>${new Date(task.due_date).toLocaleDateString()}</span>
                            </div>
                        ` : ''}
                        <div style="margin-left: auto;">
                            <button class="btn btn-secondary" onclick="setParentId('${task.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <i class="fas fa-plus"></i> Add Subtask
                            </button>
                        </div>
                    </div>
                </div>
                ${hasChildren ? task.children.map(child => renderTaskItem(child, level + 1)).join('') : ''}
            `;
        }

        function renderTasks() {
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No tasks yet</h3>
                        <p>Create your first task to get started!</p>
                    </div>
                `;
                return;
            }

            const hierarchy = buildTaskHierarchy();
            taskList.innerHTML = hierarchy.map(task => renderTaskItem(task)).join('');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Task ID copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy ID', 'error');
            });
        }

        function setParentId(taskId) {
            parentIdInput.value = taskId;
            parentIdInput.focus();
            showNotification('Parent ID set! Now add your subtask.');
        }

        async function fetchTasks() {
            try {
                const response = await fetch(`${API_BASE}/get_tasks`);
                if (!response.ok) throw new Error('Failed to fetch tasks');
                
                tasks = await response.json();
                renderTasks();
                updateStats();
            } catch (error) {
                console.error('Error fetching tasks:', error);
                showNotification('Failed to load tasks', 'error');
                taskList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading tasks</h3>
                        <p>Please check if the backend server is running.</p>
                    </div>
                `;
            }
        }

        async function addTask(taskData) {
            try {
                const response = await fetch(`${API_BASE}/add_task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add task');
                }

                const result = await response.json();
                showNotification('Task added successfully!');
                
                // Clear form
                taskForm.reset();
                
                // Refresh tasks
                await fetchTasks();
                
                return result;
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification(error.message, 'error');
                throw error;
            }
        }

        // Event listeners
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskData = {
                name: nameInput.value.trim(),
                description: descriptionInput.value.trim(),
                parent_id: parentIdInput.value.trim() || null
            };

            if (!taskData.name || !taskData.description) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            await addTask(taskData);
        });

        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (newTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark Mode';
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (savedTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            fetchTasks();

            // Auto-refresh tasks every 30 seconds
            setInterval(fetchTasks, 30000);
        });
    </script>
</body>
</html>
